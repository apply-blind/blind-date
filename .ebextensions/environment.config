files:
  "/opt/elasticbeanstalk/hooks/appdeploy/pre/99_export_envvars.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash

      # EB 환경 변수를 /etc/environment에 export
      export_env_var() {
        local key=$1
        local value=$2
        if [ -n "$value" ]; then
          echo "export $key='$value'" >> /etc/environment
        fi
      }

      # 기존 설정 백업 및 초기화
      cp /etc/environment /etc/environment.backup || true
      grep -v "^export DB_URL\|^export DB_USERNAME\|^export DB_PASSWORD\|^export REDIS_HOST\|^export REDIS_PORT\|^export ELASTICSEARCH_URIS\|^export KAFKA_BOOTSTRAP_SERVERS\|^export CORS_ALLOWED_ORIGINS\|^export KAKAO_CLIENT_ID\|^export KAKAO_CLIENT_SECRET\|^export KAKAO_REDIRECT_URI\|^export JWT_SECRET\|^export HMAC_SECRET\|^export BASE_URL\|^export AWS_S3_BUCKET_NAME\|^export AWS_S3_BASE_URL\|^export AWS_CLOUDFRONT_DOMAIN\|^export SPRING_PROFILES_ACTIVE" /etc/environment > /etc/environment.tmp || true
      mv /etc/environment.tmp /etc/environment

      # EB 환경 변수 내보내기
      export_env_var "DB_URL" "$(/opt/elasticbeanstalk/bin/get-config environment -k DB_URL)"
      export_env_var "DB_USERNAME" "$(/opt/elasticbeanstalk/bin/get-config environment -k DB_USERNAME)"
      export_env_var "DB_PASSWORD" "$(/opt/elasticbeanstalk/bin/get-config environment -k DB_PASSWORD)"
      export_env_var "REDIS_HOST" "$(/opt/elasticbeanstalk/bin/get-config environment -k REDIS_HOST)"
      export_env_var "REDIS_PORT" "$(/opt/elasticbeanstalk/bin/get-config environment -k REDIS_PORT)"
      export_env_var "ELASTICSEARCH_URIS" "$(/opt/elasticbeanstalk/bin/get-config environment -k ELASTICSEARCH_URIS)"
      export_env_var "KAFKA_BOOTSTRAP_SERVERS" "$(/opt/elasticbeanstalk/bin/get-config environment -k KAFKA_BOOTSTRAP_SERVERS)"
      export_env_var "CORS_ALLOWED_ORIGINS" "$(/opt/elasticbeanstalk/bin/get-config environment -k CORS_ALLOWED_ORIGINS)"
      export_env_var "KAKAO_CLIENT_ID" "$(/opt/elasticbeanstalk/bin/get-config environment -k KAKAO_CLIENT_ID)"
      export_env_var "KAKAO_CLIENT_SECRET" "$(/opt/elasticbeanstalk/bin/get-config environment -k KAKAO_CLIENT_SECRET)"
      export_env_var "KAKAO_REDIRECT_URI" "$(/opt/elasticbeanstalk/bin/get-config environment -k KAKAO_REDIRECT_URI)"
      export_env_var "JWT_SECRET" "$(/opt/elasticbeanstalk/bin/get-config environment -k JWT_SECRET)"
      export_env_var "HMAC_SECRET" "$(/opt/elasticbeanstalk/bin/get-config environment -k HMAC_SECRET)"
      export_env_var "BASE_URL" "$(/opt/elasticbeanstalk/bin/get-config environment -k BASE_URL)"
      export_env_var "AWS_S3_BUCKET_NAME" "$(/opt/elasticbeanstalk/bin/get-config environment -k AWS_S3_BUCKET_NAME)"
      export_env_var "AWS_S3_BASE_URL" "$(/opt/elasticbeanstalk/bin/get-config environment -k AWS_S3_BASE_URL)"
      export_env_var "AWS_CLOUDFRONT_DOMAIN" "$(/opt/elasticbeanstalk/bin/get-config environment -k AWS_CLOUDFRONT_DOMAIN)"
      export_env_var "SPRING_PROFILES_ACTIVE" "prod"
